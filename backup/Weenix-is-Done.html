<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Finally I finished the biggest project in Operating Systems CSCI169 at Brown. It took me about two months to finish the job, which is 2500 line of C c">
    

    <!--Author-->
    
        <meta name="author" content="Xiaodong">
    

    <!-- Title -->
    
    <title>Weenix is Done | Xiaodong Zhang</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Noto+Serif:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- Content -->
    <section class="article-container">
<!-- Back Home -->
<a class="nav-back" href="/">
    <i class="fa fa-puzzle-piece"></i>
</a>

<!-- Page Header -->
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Weenix is Done</h1>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p><img src="/img/weenix.png"></p>
<p>Finally I finished the biggest project in Operating Systems CSCI169 at Brown. It took me about two months to finish the job, which is 2500 line of C code in system level. Not too much, but it makes me feel good when my own operating system can support user level programs successfully.</p>
<p>projectä¸€å…±åˆ†5ä¸ªassignmentsï¼Œåˆ†åˆ«æ˜¯<code>procs</code>, <code>drivers</code>, <code>vfs</code>, <code>s5fs</code>, <code>vm</code>ã€‚è¶ç€æœŸæœ«è€ƒè¯•ä¹‹å‰ï¼ŒæŠŠç›¸å…³å†…å®¹ä¹Ÿæ€»ç»“ä¸€ä¸‹ã€‚</p>
<h3><span id="procs">PROCS</span><a href="#procs" class="header-anchor">#</a></h3>
<p>ä¸»è¦æ˜¯å®ç°OSæœ€é¡¶å±‚çš„processç®¡ç†ï¼Œå…¶ä¸­åŒ…æ‹¬processå’Œthreadçš„æ–°å»ºä¸é”€æ¯ï¼Œä»¥åŠprocessçš„è°ƒåº¦ç­–ç•¥ã€‚å®ç°ä¸Šæ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹ï¼Œå› ä¸ºè¦æ±‚æ˜¯æœ€ç®€å•çš„åŠŸèƒ½ï¼Œä¸éœ€è¦è€ƒè™‘preemptionï¼ŒCPUçš„é‡Šæ”¾å–å†³äºprocessè‡ªå·±ï¼Œä¸ä¾èµ–ä¸æ—¶é’Ÿã€‚å¹¶ä¸”æ¯ä¸ªprocessåªæœ‰ä¸€ä¸ªthreadã€‚</p>
<p>å”¯ä¸€å€¼å¾—å…³æ³¨çš„ï¼Œæ˜¯èµ„æºå›æ”¶çš„é—®é¢˜ã€‚ä¸€ä¸ªprocessçš„ç»“æŸï¼Œé¦–å…ˆæ˜¯æ‰§è¡Œ<code>do_exit</code>å‡½æ•°ï¼Œå‡½æ•°å†…éƒ¨è°ƒç”¨<code>kthread_exit</code>ï¼Œä¹‹åthreadé€šçŸ¥processè¯´æˆ‘ç»“æŸè¿è¡Œäº†ï¼Œä½ å¯ä»¥æŠŠæˆ‘å›æ”¶äº†ã€‚è¿™æ—¶å€™processå†å»æ‰§è¡Œ<code>cleanup</code>ã€‚<code>cleanup</code>æ¶‰åŠå¤šé¡¹å†…å®¹å¤„ç†ï¼š 1. å…³é—­æ‰€æœ‰è¯¥processæ‰“å¼€çš„æ–‡ä»¶ 2. å–æ¶ˆå¯¹current working directoryçš„å¼•ç”¨ï¼ˆæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸ªä¸€ä¸ªcwdï¼‰ 3. é”€æ¯virtual memory map. è¿™ä¸ªåœ¨<code>vm</code>é˜¶æ®µå†åšè¯´æ˜ã€‚ 4. å¦‚æœè¿™processä¸æ˜¯init processï¼ˆ<code>pid=1</code>ï¼‰ï¼Œé‚£å°±éœ€è¦å°†ä»–æ‰€æœ‰çš„å­è¿›ç¨‹è½¬ç§»ç»™init process.</p>
<p>è¿™å››æ­¥ä¹‹åï¼Œè¿™ä¸ªè¿›ç¨‹è‡ªå·±èƒ½åšçš„é”€æ¯å·¥ä½œå°±å·²ç»å®Œæˆäº†ï¼Œä½†æ˜¯è¿™ä¸ªè¿›ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰è¢«é”€æ¯çš„ï¼ˆè‡ªå·±æ— æ³•é”€æ¯è‡ªå·±ï¼Œå› ä¸ºè‡ªå·±å¿…é¡»è¿è¡Œåœ¨stackä¸Šé¢ï¼‰ï¼Œä½†æ˜¯å®ƒæŠŠè‡ªå·±çš„çŠ¶æ€è®¾ç½®æˆäº†<code>PROC_DEAD</code>ï¼Œå®ƒçš„parent processä¸€å®šåœ¨æ‰§è¡Œ<code>do_waitpid</code>ç­‰å¾…å…¶å­è¿›ç¨‹çš„ç»“æŸï¼Œå¹¶çœŸæ­£å°†å…¶é‡Šæ”¾ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯init processç»“æŸçš„æ¡ä»¶ï¼Œæ˜¯åªè¦æœ‰ä¸€ä¸ªä»–çš„child processç»“æŸã€‚è¿™æ ·å¦‚æœinit processæœ‰å¤šä¸ªchild processä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ</p>
<p>å‰©ä¸‹çš„ï¼Œå°±æ˜¯idle processå›æ”¶init processã€‚</p>
<p>å¦ä¸€ä¸ªå…³æ³¨ç‚¹æ˜¯schedulerã€‚åœ¨<code>sched_switch</code>çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘interruptçš„å‘ç”ŸåŠrunning queueä¸ºç©ºçš„æƒ…å†µã€‚</p>
<ul>
<li>å¯¹äºinterruptï¼Œæˆ‘ä»¬åœ¨è¿›å…¥<code>sched_switch</code>çš„æ—¶å€™å°±éœ€è¦å°†interrupt levelè°ƒæˆæœ€é«˜ï¼Œåœ¨ç»“æŸä¹‹å‰å†è®¾ç½®æˆåŸæ¥çš„å€¼ã€‚</li>
<li>å¯¹äºrunning queueä¸ºç©ºçš„æƒ…å†µï¼Œæˆ‘ä»¬åº”å½“å…è®¸interruptå‘ç”Ÿï¼Œå› ä¸ºå…¶ä»–è¿›ç¨‹å¯èƒ½sleep on some waiting queuesï¼Œinterruptå‘ç”Ÿäº†èƒ½å°†å”¤é†’ï¼Œå¹¶é‡æ–°è¿›å…¥running queueã€‚</li>
</ul>
<hr>
<h3><span id="drivers">DRIVERS</span><a href="#drivers" class="header-anchor">#</a></h3>
<p>è¿™ä¸€å—ä¸»è¦å®ç°äº†ä¸¤ä¸ªé©±åŠ¨ï¼Œä¸€ä¸ªæ˜¯diskï¼Œä¸€ä¸ªæ˜¯ttyã€‚</p>
<ol type="1">
<li>disk</li>
</ol>
<p>å®é™…çš„ç£ç›˜æ“ä½œä¹Ÿä¸æ˜¯æˆ‘ä»¬æ¥å®ç°ï¼Œè°ƒç”¨ç°æˆçš„æ–¹æ³•ï¼ˆè€Œä¸”æ ¹æœ¬çœ‹ä¸æ‡‚æ˜¯æ€ä¹ˆåšçš„ï¼Œè®¾è®¡DMAä»€ä¹ˆçš„ï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦äº†è§£çš„æ˜¯diskçš„è¯»å†™æ“ä½œæ˜¯å¼‚æ­¥çš„ã€‚å°±æ˜¯ä»»ä½•ä¸€ä¸ªprocessåœ¨è¿›è¡Œç£ç›˜æ“ä½œä¹‹å‰ï¼Œéƒ½ä¼šsleep on the disk's waitqã€‚å› ä¸ºç£ç›˜æ“ä½œå¾ˆè€—æ—¶ï¼Œå½“æ“ä½œå®Œæˆä¹‹åï¼Œç£ç›˜è§¦å‘CPUçš„interruptï¼Œè°ƒç”¨æˆ‘ä»¬å†™çš„handlerå°†ä¹‹å‰è¿›è¡Œè¯»å†™æ“ä½œçš„è¿›ç¨‹å”¤é†’ã€‚</p>
<ol start="2" type="1">
<li>tty</li>
</ol>
<p>è¿™ä¸€å—çš„å®ç°å°±æ¯”è¾ƒæœ‰æ„æ€äº†ã€‚é¦–å…ˆttyçš„è¿è¡Œæœºåˆ¶è·Ÿdiskæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ç”±interrupté©±åŠ¨ã€‚ä½†æ˜¯ç›¸æ¯”diskï¼Œttyçš„å®ç°è¦å¤æ‚è®¸å¤šã€‚</p>
<p>é¦–å…ˆæ¯ä¸€ä¸ªttyéƒ½æ˜¯ä¸ä¸€ä¸ªprocessç›¸å…³çš„ã€‚æˆ‘ä»¬æœ€ç»ˆå®ç°äº†ä¸‰ä¸ªttyï¼Œå¯¹åº”ä¸‰ä¸ªprocessã€‚æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šå°è¯•å»è¯»å–ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œè¿™ä¸ªå­˜å‚¨ç”¨æˆ·è¾“å…¥çš„å†…å®¹çš„bufferæ˜¯ç”±æˆ‘ä»¬ç»´æŠ¤çš„ã€‚å¦‚æœè¿›ç¨‹è¯»ä¸åˆ°å†…å®¹ï¼Œå°±ä¼šsleepã€‚</p>
<p>é‚£é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆè¯»å–ç”¨æˆ·è¾“å…¥çš„å†…å®¹å‘¢ï¼Ÿé€šè¿‡é”®ç›˜å•Šï¼ç”¨æˆ·ï¼ˆäººç±»ï¼‰æ¯æŒ‰ä¸€ä¸ªæŒ‰é”®éƒ½ä¼šè§¦å‘ä¸€ä¸ªinterruptï¼Œè¿™ä¸ªinterruptçš„handleræ˜¯æˆ‘ä»¬æ¥å®ç°çš„ï¼Œå¤„ç†ç”¨æˆ·çš„è¾“å…¥ï¼Œå¹¶æ˜¾ç¤ºåœ¨ç»ˆç«¯ä¸Šç»™ç”¨æˆ·çœ‹ã€‚å…¶ä¸­æ¯”è¾ƒå…³é”®çš„æ˜¯ç”¨æˆ·è¾“å…¥enterã€backspaceå’Œctrl+Dçš„æƒ…å†µã€‚è¿™å…¶ä¸­è®¾è®¡å¾ªç¯bufferçš„è®¾è®¡ä½¿ç”¨ã€‚å¦‚æœç”¨æˆ·è¾“å…¥äº†enterï¼Œå°±éœ€è¦å°†ä¹‹å‰sleepçš„processå”¤é†’ï¼Œè¿›è¡Œå¤„ç†ç”¨æˆ·è¾“å…¥çš„å†…å®¹ã€‚ è¿™ä¸ªå¤„ç†å¯èƒ½è®¾è®¡åç»­shellçš„æ“ä½œï¼Œå› ä¸ºæ¯ä¸ªshellä¼šç»‘å®šä¸€ä¸ªttyï¼Œç”¨æˆ·è¾“å…¥çš„å†…å®¹å°±å¯ä»¥ä¼ é€’åˆ°shellè¿›è¡Œè§£ææ“ä½œäº†ã€‚</p>
<hr>
<h3><span id="vfs">VFS</span><a href="#vfs" class="header-anchor">#</a></h3>
<hr>
<h3><span id="s5fs">S5FS</span><a href="#s5fs" class="header-anchor">#</a></h3>
<hr>
<h3><span id="vm">VM</span><a href="#vm" class="header-anchor">#</a></h3>
<p>First, let's talk about how does the CPU get a phyical memory address. CPU is executing instructions, now it gets a virtual address. It needs to be translated into a physical address to get the true value. So CPU first looks up the TLB (it's a cache of page table inside of CPU). If the entry exists, job is done. If not, then it goes on the search the page table in main memory. The physical address of page table is stored in a register call <code>CR3</code>, so there is no need to translate it. If it finds the entry in the page table, job is done, and TLB is updated. If not, it goes to page fault hander by sending an interrupt to CPU, and the handler is implemented by us. All these searching jobs are done by a hardware call <code>MMU</code>.</p>

 
                <!-- Meta -->
                <div class="post-meta">
                    <hr>
                    <br>
                    <div class="post-tags">
                        
                    </div>
                    <div class="post-date">
                        04 / 29 / 2019
                    </div>
                </div>
            </div>

            <!-- Comments -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- Disqus Comments -->


            </div>
        </div>
    </div>
</article>
</section>

    <!-- Scripts -->
    <!-- jQuery -->
<script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

	<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



<script type="text/javascript">
	console.log('Hexo-theme-hollow designed by zchen9 ğŸ™‹ Â© 2015-' + (new Date()).getFullYear());
</script>

    <!-- Google Analytics -->
    

</body>

</html>